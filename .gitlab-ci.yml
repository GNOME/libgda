# This file is a template, and might need editing before it works on your project.
# use the official gcc image, based on debian
# can use verions as well, like gcc:5.2
# see https://hub.docker.com/_/gcc/
image: ubuntu:devel

services:
  - postgres:latest
  - mysql:5.7

stages:
  - build

variables:
  POSTGRES_DB: test
  POSTGRES_USER: test
  POSTGRES_PASSWORD: test1
  POSTGRES_HOST: postgres
  MYSQL_DATABASE: test
  MYSQL_ROOT_PASSWORD: test1
  MYSQL_USER: root
  MYSQL_HOST: mysql
  DEPENDENCIES: gcc gettext gtk-doc-tools make autoconf
                meson ninja-build
                libgtk-3-dev libxml2-dev gnome-common
                libsqlite3-dev
                gobject-introspection libssl-dev libmysqlclient-dev
                default-libmysqld-dev libldap2-dev libpq-dev
                libgtksourceview-3.0-dev
                libgdk-pixbuf2.0-dev
                libgraphviz-dev
                libisocodes-dev
                libxslt1-dev
                libjson-glib-dev
                libgcrypt20-dev
                libssl-dev
                libldap2-dev
                libgoocanvas-2.0-dev
                libhsqldb1.8.0-java
                yelp-tools
                iso-codes
                libgirepository1.0-dev
                libgee-0.8-dev
                valadoc
                libgladeui-dev
                postgresql-client
                postgresql-client-common

  GIT_SUBMODULE_STRATEGY: normal
  SQLITE_DBCREATE_PARAMS: "DB_DIR=."
  SQLITE_CNC_PARAMS: "DB_DIR=."
  POSTGRESQL_DBCREATE_PARAMS: "HOST=$POSTGRES_HOST;ADM_LOGIN=$POSTGRES_USER;ADM_PASSWORD=$POSTGRES_PASSWORD"
  POSTGRESQL_CNC_PARAMS: "HOST=$POSTGRES_HOST;USERNAME=$POSTGRES_USER;PASSWORD=$POSTGRES_PASSWORD"
  POSTGRESQL_META_CNC: "DB_NAME=$POSTGRES_DB;HOST=$POSTGRES_HOST;USERNAME=$POSTGRES_USER;PASSWORD=$POSTGRES_PASSWORD"
  MYSQL_CNC_PARAMS: "DB_NAME=$MYSQL_DATABASE;HOST=$MYSQL_HOST;USERNAME=$MYSQL_USER;PASSWORD=$MYSQL_ROOT_PASSWORD"
  MYSQL_META_CNC: "DB_NAME=$MYSQL_DATABASE;HOST=$MYSQL_HOST;USERNAME=$MYSQL_USER;PASSWORD=$MYSQL_ROOT_PASSWORD"
  
before_script:
  - apt update && apt -y install $DEPENDENCIES

autotools_build:
  stage: build
  script:
  - ./autogen.sh
  - make distclean
  - mkdir _build
  - cd _build
  - ../configure
  - make
  - broadwayd &
  - GDK_BACKEND=broadway make check
  artifacts:
    when: on_failure
    paths:
    - _build/tests/test-suite.log
    - _build/tests/test-bin-converter.log
    - _build/tests/test-ddl-creator.log
    - _build/tests/test-input-parsers.log
    - _build/tests/test-server-operation.log
    - _build/tests/test-sql-identifier.log
    - _build/tests/test-suite.log
    - _build/tests/test-connection-string-split.log
    - _build/tests/test-identifiers-quotes.log
    - _build/tests/test-quark-list.log
    - _build/tests/test-sql-builder.log
    - _build/tests/test-sql-renderer.log
    - _build/libgda/test-suite.log
    - _build/libgda/test-cnc-exec.log
    - _build/libgda/test-cnc-meta.log
    - _build/libgda/test-cnc-open.log
    - _build/tests/data-models/test-suite.log
    - _build/tests/data-models/check_data_proxy.log
    - _build/tests/data-models/check_empty_rs.log
    - _build/tests/data-models/check_model_errors.log
    - _build/tests/data-models/check_pivot.log
    - _build/tests/data-models/check_vcnc.log
    - _build/tests/data-models/check_data_select_iter.log
    - _build/tests/data-models/check_model_copy.log
    - _build/tests/data-models/check_model_import.log
    - _build/tests/data-models/check_pmodel.log
    - _build/tests/data-models/check_virtual.log
    - _build/tests/meta-store/test-suite.log
    - _build/tests/meta-store/check_meta_store_postgresql.log
    - _build/tests/meta-store/check_meta_store_memory.log
    - _build/tests/meta-store/check_meta_store_mysql.log
    - _build/tests/meta-store/check_meta_store_postgresql.log
    - _build/tests/meta-store/check_meta_store_sqlite.log
    - _build/tests/value-holders/test-suite.log
    - _build/tests/value-holders/check_holder.log
    - _build/tests/value-holders/check_set.log
    - _build/tests/value-holders/check_statement.log 
    - _build/tests/parser/test-suite.log
    - _build/tests/parser/check_dml_comp.log
    - _build/tests/parser/check_normalization.log
    - _build/tests/parser/check_parser.log
    - _build/tests/parser/check_rewrite_for_default.log
    - _build/tests/parser/check_script.log
    - _build/tests/parser/check_validation.log
    - _build/tests/providers/test-suite.log
    - _build/tests/providers/check_mysql.log
    - _build/tests/providers/check_postgres.log
    - _build/tests/providers/check_sqlite.log 
    expire_in: 1 week

meson_build:
  stage: build
  script:
  - export PGPASSWORD=$POSTGRES_PASSWORD
  - psql -h "postgres" -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "SELECT 'OK' AS status;"
  - meson _build --prefix=/usr -Denable-ci-environment=true -Denable-debug=true 
  - cd _build
  - ninja
  - broadwayd &
  - GDK_BACKEND=broadway meson test
  - ninja install
  - cd ..
  artifacts:
    when: on_failure
    paths:
    - _build/meson-logs/testlog.txt
    - _build/meson-logs/meson-log.txt
    - _build/doc/C/libgda/html
    - _build/doc/C/libgdaui/html
    - _build/doc/Gda-6.0
    - _build/doc/Gdaui-6.0
    expire_in: 1 week
pages:
  stage: build
  script:
  - meson _build
  - cd _build
  - ninja
  - ninja install
  - mkdir ../public
  - mv doc/index.html ../public/
  - mkdir ../public/C
  - mv doc/C/* ../public/C/
  - mkdir ../public/vala
  - mv doc/Gda-6.0 ../public/vala
  - mv doc/Gdaui-6.0 ../public/vala
  - cp libgda/libgda-6.0.vapi ../public/vala
  - cp libgda-ui/libgdaui-6.0.vapi ../public/vala
  artifacts:
    paths:
    - public
